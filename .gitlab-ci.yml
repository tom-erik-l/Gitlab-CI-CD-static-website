stages:
  - build
  - test
  - deploy staging
  - deploy production
  - production tests

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - ".\\node_modules"

variables:
  STAGING_DOMAIN: sweet-answer-staging.surge.sh
  PRODUCTION_DOMAIN: sweet-answer.surge.sh

build website:
  stage: build
  script: 
    - SET NODE_EXTRA_CA_CERTS=C:\Trainings\zScalerRootCertificate.cer
    - SET NODE_TLS_REJECT_UNAUTHORIZED=0
    - call npm config set strict-ssl=false
    - call npm config set cafile C:\Trainings\zScalerRootCertificate.cer
    - echo %CI_COMMIT_SHORT_SHA%
    - call npm install
    - call npm install -g gatsby-cli
    - call gatsby build
    - ls
    - echo "sed -i 's/%%%%VERSION%%%%/%CI_COMMIT_SHORT_SHA%/' .\\public\\index.html"
    - sed -i 's/%%VERSION%%/%CI_COMMIT_SHORT_SHA%/' .\\public\\index.html

  artifacts:
    paths:
      - ".\\public"
      - ".\\.cache"

test artifact:
  stage: test 
  cache: {}
  script:
    - grep -q "Gatsby" .\\public\\index.html

# test website:
#  stage: test
#  script:
#    - SET NODE_EXTRA_CA_CERTS=C:\Trainings\zScalerRootCertificate.cer
#    - SET NODE_TLS_REJECT_UNAUTHORIZED=0
#    - call npm config set strict-ssl=false
#    - call npm config set cafile C:\Trainings\zScalerRootCertificate.cer
#    - call npm install
#    - call npm install -g gatsby-cli
#    - START /B "" gatsby serve --port 9001 
#    - sleep 30
#    - curl "http://localhost:9001" | tac | tac | grep -q "Gatsby"


deploy staging:
  stage: deploy staging
  environment:
    name: staging
    url: http://$STAGING_DOMAIN
  cache: {}
  only:
    - master
  script:
    - call npm install --global surge
    - surge --project ./public --domain $STAGING_DOMAIN

deploy production:
  stage: deploy production
  environment:
    name: production
    url: http://$PRODUCTION_DOMAIN
  # when: manual
  # allow_failure: false
  cache: {}
  only:
  - master
  script:
    - call npm install --global surge
    - surge --project ./public --domain $PRODUCTION_DOMAIN

production tests:
  stage: production tests
  cache: {}
  only:
  - master
  script:
    - curl "$PRODUCTION_DOMAIN" | grep -q "Hi people"
    - curl "$PRODUCTION_DOMAIN" | grep -q "%CI_COMMIT_SHORT_SHA%"